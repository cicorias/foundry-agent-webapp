# Backend - ASP.NET Core API

**AI Assistance**: See `.github/skills/writing-csharp-code/SKILL.md` for coding patterns.

## Overview

ASP.NET Core 9 Minimal API application that:
- Serves both the REST API (`/api/*`) and React SPA (single container pattern)
- Authenticates requests via JWT Bearer tokens from Microsoft Entra ID
- Communicates with Azure AI Foundry Agent Service using managed identity
- Streams AI agent responses via Server-Sent Events (SSE)

## Key Features

- **Single Container**: Serves both API and frontend from `wwwroot`
- **JWT Authentication**: Validates tokens with `Chat.ReadWrite` scope
- **AI Agent Integration**: Azure.AI.Agents.Persistent v1.2.0-beta.6 (pinned)
- **Streaming**: SSE-based chat streaming with cancellation support
- **Environment-Aware Auth**: ChainedTokenCredential (dev) / ManagedIdentityCredential (prod)

## Project Structure

```
WebApp.Api/
├── Program.cs                    # Middleware pipeline + endpoints
├── Models/                       # Request/response DTOs
│   ├── ChatRequest.cs
│   ├── ChatResponse.cs
│   └── ConversationModels.cs
├── Services/
│   └── AzureAIAgentService.cs   # AI Foundry client + streaming
└── appsettings.json              # Configuration (no secrets)
```

## Running Locally

### Prerequisites
- .NET 9 SDK
- Azure CLI authenticated (`az login`)
- `.env` file generated (run `azd up` first)

### Start

```powershell
cd backend/WebApp.Api
dotnet run
```

**Or** use the unified script:
```powershell
.\deployment\scripts\start-local-dev.ps1
```

Backend runs at http://localhost:8080 (API + static files).

### Configuration

`.env` file (auto-generated by `azd up`):
```
AzureAd__ClientId=...
AzureAd__TenantId=...
AI_AGENT_ENDPOINT=...
AI_AGENT_ID=...
```

Environment variables are loaded before ASP.NET Core configuration builder runs.

## API Endpoints

| Endpoint | Method | Auth | Purpose |
|----------|--------|------|---------|
| `/api/agents` | GET | Required | List available agents (metadata) |
| `/api/chat/stream` | POST | Required | Send message, receive streaming response |
| `/api/threads` | POST | Required | Create new thread (future) |

All endpoints require `Chat.ReadWrite` scope in JWT token.

## Development Tips

- **Hot reload**: Enabled by default with `dotnet watch`
- **CORS**: Enabled for `http://localhost:5173` in dev mode only
- **Logging**: Structured logging to console (JSON in production)
- **Debugging**: Attach debugger via VS Code or Visual Studio

## Building

```powershell
dotnet build -c Release
dotnet publish -c Release -o ./publish
```

Production builds are created in Docker multi-stage builds (see `deployment/docker/frontend.Dockerfile`).

## Testing

```powershell
# Run tests (if added)
dotnet test

# Check for vulnerabilities
dotnet list package --vulnerable
```

## Key Dependencies

| Package | Version | Purpose |
|---------|---------|---------|
| Azure.AI.Agents.Persistent | 1.2.0-beta.6 | AI Foundry Agent Service SDK (pinned) |
| Azure.Identity | Latest | ManagedIdentityCredential for Azure auth |
| Microsoft.Identity.Web | Latest | JWT Bearer authentication |
| Microsoft.AspNetCore.OpenApi | Latest | OpenAPI documentation |

**SDK pinning rationale**: Beta SDK pinned to ensure stability until GA release.

## Security

- ✅ JWT validation with dual audience support
- ✅ HTTPS-only in production (Container Apps)
- ✅ No secrets in code or `appsettings.json`
- ✅ Managed identity for Azure resource access
- ✅ Scope-based authorization (`Chat.ReadWrite`)

## Troubleshooting

| Issue | Solution |
|-------|----------|
| 401 Unauthorized | Verify token has `Chat.ReadWrite` scope |
| AI Foundry connection fails | Check `AI_AGENT_ENDPOINT` in `.env` |
| Local auth fails | Run `az login` or `azd auth login` |
| Port 8080 in use | Change in `launchSettings.json` |

For AI-assisted development, see `.github/skills/writing-csharp-code/SKILL.md` and `.github/skills/implementing-chat-streaming/SKILL.md`.
